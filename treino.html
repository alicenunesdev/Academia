<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Treino</title>
  <style>
    /* Layout padrão - cores, navbar */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f5f5f5;
      color: #333;
    }

    nav {
      background-color: #005f73;
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      font-size: 20px;
      font-weight: bold;
    }

    nav a {
      color: white;
      text-decoration: none;
      margin-left: 20px;
      font-weight: normal;
      font-size: 16px;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 {
      color: #0a9396;
      margin-bottom: 20px;
    }

    label {
      font-weight: 600;
    }

    select, button {
      font-size: 16px;
      padding: 8px;
      margin: 10px 0 20px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }

    button {
      background-color: #0a9396;
      border: none;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover:not(:disabled) {
      background-color: #007f7f;
    }

    button:disabled {
      background-color: #a7a7a7;
      cursor: not-allowed;
    }

    .card {
      background: #e0fbfc;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    }

    .atividade-header h2 {
      margin: 0 0 15px 0;
      color: #005f73;
    }

    .series div {
      margin-bottom: 12px;
    }

    input.input-reps, input.input-carga {
      width: 70px;
      margin-right: 15px;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    input.check-serie {
      transform: scale(1.2);
      margin-right: 8px;
      vertical-align: middle;
      cursor: pointer;
    }

    .cronometro-serie {
      font-weight: bold;
      color: #005f73;
    }

    .hidden {
      display: none;
    }

    .botoes-controle {
      margin-top: 20px;
    }

    .botoes-controle button {
      margin-right: 15px;
      padding: 10px 18px;
      border-radius: 8px;
    }

    .botao-encerrar {
      margin-top: 30px;
      background-color: #bb3e03;
      width: 100%;
      font-size: 18px;
      padding: 14px;
      border-radius: 10px;
    }

    .botao-encerrar:hover {
      background-color: #a53302;
    }
  </style>
</head>
<body>

<nav>
  Meu Treinador
  <a href="treino.html">Treino</a>
  <a href="historico.html">Histórico</a>
</nav>

<main>
  <h1>Treino</h1>
  <label for="treinoSelect">Selecione um treino:</label>
  <select id="treinoSelect">
    <option value="">Carregando treinos...</option>
  </select>
  <button id="iniciarBtn">Iniciar Treino</button>

  <div id="treinoContainer"></div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs, getDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    // Substitua pelas suas credenciais do Firebase
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_AUTH_DOMAIN",
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_BUCKET",
    messagingSenderId: "SEU_MESSAGING_ID",
    appId: "SEU_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const treinoSelect = document.getElementById("treinoSelect");
  const iniciarBtn = document.getElementById("iniciarBtn");
  const treinoContainer = document.getElementById("treinoContainer");

  let atual = 0;
  let grupos = [];
  let dadosPreenchidos = {};
  let timers = {};

  async function carregarTreinos() {
    const snapshot = await getDocs(collection(db, "treinos"));
    treinoSelect.innerHTML = '<option value="">Selecione</option>';

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const option = document.createElement("option");
      option.value = docSnap.id;
      option.textContent = `${data.usuario} - ${data.tipoTreino}`;
      treinoSelect.appendChild(option);
    });

    if (treinoSelect.options.length === 1) {
      treinoSelect.innerHTML = '<option value="">Nenhum treino disponível</option>';
    }
  }

  carregarTreinos();

  iniciarBtn.addEventListener("click", async () => {
    const treinoId = treinoSelect.value;
    if (!treinoId) {
      alert("Selecione um treino");
      return;
    }

    const docSnap = await getDoc(doc(db, "treinos", treinoId));
    if (!docSnap.exists()) {
      alert("Treino não encontrado");
      return;
    }

    const data = docSnap.data();
    grupos = data.grupos;
    atual = 0;
    dadosPreenchidos = {};
    timers = {};

    treinoSelect.disabled = true;
    iniciarBtn.disabled = true;

    exibirExercicio(atual);
  });

  function exibirExercicio(index) {
    const grupo = grupos[index];
    treinoContainer.innerHTML = "";

    const chaveGrupo = `grupo${index}`;
    if (!dadosPreenchidos[chaveGrupo]) {
      dadosPreenchidos[chaveGrupo] = Array.from({ length: grupo.serie }).map(() => ({
        repeticoes: grupo.repeticao || '',
        carga: '',
        check: false,
        tempo: "00:00"
      }));
    }

    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <div class="atividade-header">
        <h2>${grupo.grupo}</h2>
      </div>

      <div class="series">
        ${dadosPreenchidos[chaveGrupo].map((serie, i) => `
          <div>
            <label>Série ${i + 1}</label><br/>
            <input type="number" placeholder="Reps" value="${serie.repeticoes}" data-serie="${i}" class="input-reps">
            <input type="number" placeholder="Carga (kg)" value="${serie.carga}" data-serie="${i}" class="input-carga">
            <input type="checkbox" class="check-serie" data-serie="${i}" ${serie.check ? 'checked' : ''}> ✔
            <span class="cronometro-serie ${serie.check ? '' : 'hidden'}">${serie.tempo}</span>
          </div>
        `).join('')}
      </div>

      <div class="botoes-controle">
        <button id="anteriorBtn" class="botao-pular">⬅️ Anterior</button>
        <button id="proximoBtn" class="botao-completar">➡️ Próximo</button>
      </div>

      <button id="encerrarBtn" class="botao-encerrar" style="margin-top:20px;">⚡ Encerrar Treino</button>
    `;

    treinoContainer.appendChild(div);

    // Listeners inputs reps
    document.querySelectorAll(".input-reps").forEach(input => {
      input.addEventListener("input", (e) => {
        const idx = e.target.dataset.serie;
        dadosPreenchidos[chaveGrupo][idx].repeticoes = e.target.value;
      });
    });

    // Listeners inputs carga
    document.querySelectorAll(".input-carga").forEach(input => {
      input.addEventListener("input", (e) => {
        const idx = e.target.dataset.serie;
        dadosPreenchidos[chaveGrupo][idx].carga = e.target.value;
      });
    });

    // Listeners check
    document.querySelectorAll(".check-serie").forEach((checkbox) => {
      checkbox.addEventListener("change", (e) => {
        const idx = e.target.dataset.serie;
        const timerEl = e.target.nextElementSibling;

        if (e.target.checked) {
          timerEl.classList.remove("hidden");
          iniciarCronometro(timerEl, chaveGrupo, idx);
          dadosPreenchidos[chaveGrupo][idx].check = true;
        } else {
          timerEl.classList.add("hidden");
          dadosPreenchidos[chaveGrupo][idx].check = false;
          dadosPreenchidos[chaveGrupo][idx].tempo = "00:00";
          timerEl.textContent = "00:00";
          pararCronometro(chaveGrupo, idx);
        }
      });
    });

    document.getElementById("anteriorBtn").addEventListener("click", () => {
      if (atual > 0) {
        atual--;
        exibirExercicio(atual);
      }
    });

    document.getElementById("proximoBtn").addEventListener("click", () => {
      if (atual + 1 < grupos.length) {
        atual++;
        exibirExercicio(atual);
      } else {
        encerrarTreino();
      }
    });

    document.getElementById("encerrarBtn").addEventListener("click", () => {
      encerrarTreino();
    });
  }

  // Funções de cronômetro
  function iniciarCronometro(el, chave, idx) {
    if (timers[chave] && timers[chave][idx]) return; // já existe

    if (!timers[chave]) timers[chave] = {};

    let [min, sec] = el.textContent.split(":").map(Number);
    let segundos = min * 60 + sec;

    timers[chave][idx] = setInterval(() => {
      segundos++;
      const minStr = Math.floor(segundos / 60).toString().padStart(2, '0');
      const secStr = (segundos % 60).toString().padStart(2, '0');
      el.textContent = `${minStr}:${secStr}`;
      dadosPreenchidos[chave][idx].tempo = el.textContent;
    }, 1000);
  }

  function pararCronometro(chave, idx) {
    if (timers[chave] && timers[chave][idx]) {
      clearInterval(timers[chave][idx]);
      delete timers[chave][idx];
    }
  }

  async function salvarTreinoFinalizado() {
    if (!grupos || grupos.length === 0) return;

    const treinoFinalizado = {
      usuario: "Usuário Exemplo", // substitua por valor real se tiver autenticação
      tipoTreino: treinoSelect.options[treinoSelect.selectedIndex].text || "Tipo Exemplo",
      dataFinalizacao: new Date().toISOString(),
      grupos: grupos.map((grupo, i) => ({
        grupo: grupo.grupo,
        series: dadosPreenchidos[`grupo${i}`] || []
      })),
    };

    try {
      const novaRef = doc(collection(db, "treinos-finalizados"));
      await setDoc(novaRef, treinoFinalizado);
      console.log("Treino finalizado salvo com sucesso.");
    } catch (error) {
      console.error("Erro ao salvar treino finalizado:", error);
    }
  }

  async function encerrarTreino() {
    await salvarTreinoFinalizado();

    treinoContainer.innerHTML = "<h2 style='text-align:center; color: #0a9396;'>🏆 Treino finalizado!</h2>";
    treinoSelect.disabled = false;
    iniciarBtn.disabled = false;
  }
</script>

</body>
</html>
